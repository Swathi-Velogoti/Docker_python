name: CI - Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_call:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: "Deploy to Environments"
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-images

      - name: Load Docker image
        run: |
          docker load -i /tmp/docker-images/myapp.tar
          echo "✅ Docker image loaded"

      - name: Tag and push Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/myapp:$IMAGE_TAG"
          
          docker tag myapp:$IMAGE_TAG $IMAGE_NAME
          echo "Tagged image: $IMAGE_NAME"
          
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push $IMAGE_NAME
          echo "✅ Image pushed to GitHub Container Registry"

      - name: Update Helm values for dev environment
        run: |
          cd go-web-app/helm/myapp
          sed -i "s|tag:.*|tag: \"$IMAGE_TAG\"|g" values-dev.yaml
          sed -i "s|repository:.*|repository: \"ghcr.io/${{ github.repository_owner }}/myapp\"|g" values-dev.yaml

      - name: Update Helm values for staging environment
        run: |
          cd go-web-app/helm/myapp
          sed -i "s|tag:.*|tag: \"$IMAGE_TAG\"|g" values-staging.yaml
          sed -i "s|repository:.*|repository: \"ghcr.io/${{ github.repository_owner }}/myapp\"|g" values-staging.yaml

      - name: Update Helm values for prod environment
        run: |
          cd go-web-app/helm/myapp
          sed -i "s|tag:.*|tag: \"$IMAGE_TAG\"|g" values-prod.yaml
          sed -i "s|repository:.*|repository: \"ghcr.io/${{ github.repository_owner }}/myapp\"|g" values-prod.yaml

      - name: Commit and push Helm value updates
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add go-web-app/helm/myapp/values-*.yaml
          git commit -m "Update image tag to ${{ github.sha }}" || echo "No changes to commit"
          git push

      - name: Deploy to Argo CD
        run: |
          echo "✅ Deployment complete - Argo CD will automatically sync the new image versions"
