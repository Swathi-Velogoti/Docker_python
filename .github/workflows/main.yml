name: Deploy App to EC2

on:
  push:
    branches: ["main"]

jobs:
  # Job 1: Checkout
  checkout:
    runs-on: ubuntu-latest
    name: "Job 1: Checkout Code"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Code checked out successfully
        run: echo "✅ Code checkout complete"

  # Job 2: Build Docker image
  build:
    runs-on: ubuntu-latest
    name: "Job 2: Build Docker Image"
    needs: checkout
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          IMAGE_NAME="flask-demo:latest"
          echo "Building image: $IMAGE_NAME"
          docker build -t $IMAGE_NAME .
          echo "✅ Docker image built successfully"

      - name: Save Docker image as artifact
        run: |
          mkdir -p /tmp/docker-images
          docker save flask-demo:latest -o /tmp/docker-images/flask-demo.tar
          echo "✅ Image saved to artifact"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-images/flask-demo.tar
          retention-days: 1

  # Job 3: Security Scan (Trivy)
  security-scan:
    runs-on: ubuntu-latest
    name: "Job 3: Security Scan (Trivy)"
    needs: build
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-images

      - name: Load Docker image
        run: |
          docker load -i /tmp/docker-images/flask-demo.tar
          echo "✅ Image loaded successfully"
          docker images

       - name: Run Trivy vulnerability scanner (table output)
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: 'flask-demo:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'

       - name: Run Trivy vulnerability scanner (JSON output)
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: 'flask-demo:latest'
          format: 'json'
          output: 'trivy-results.json'

       - name: Run Trivy vulnerability scanner (SARIF output)
         uses: aquasecurity/trivy-action@master
         with:
          image-ref: 'flask-demo:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

          

       - name: Check for CRITICAL vulnerabilities
          run: |
          echo "========== Trivy Security Scan Report =========="
          cat trivy-results.json | jq '.'
          
          CRITICAL_COUNT=$(cat trivy-results.json | jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' || echo 0)
          HIGH_COUNT=$(cat trivy-results.json | jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="HIGH")] | length' || echo 0)
          
          echo ""
          echo "CRITICAL Issues: $CRITICAL_COUNT"
          echo "HIGH Issues: $HIGH_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ Found CRITICAL vulnerabilities - blocking deployment"
            exit 1
          fi
          
          if [ "$HIGH_COUNT" -gt 0 ]; then
            echo "⚠️  WARNING: Found HIGH severity issues (continuing)"
          fi
          
          echo "✅ Security scan passed - proceeding to push"

  # Job 4: Push to ECR
  push:
    runs-on: ubuntu-latest
    name: "Job 4: Push to ECR"
    needs: security-scan
    outputs:
      image-uri: ${{ steps.push.outputs.image-uri }}
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-images

      - name: Load Docker image
        run: |
          docker load -i /tmp/docker-images/flask-demo.tar
          echo "✅ Image loaded successfully"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Tag and push image to ECR
        id: push
        run: |
          IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:latest"
          echo "Tagging image as: $IMAGE_URI"
          docker tag flask-demo:latest $IMAGE_URI
          docker push $IMAGE_URI
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "✅ Image pushed to ECR successfully"

  # Job 5: Deploy to EC2
  deploy:
    runs-on: ubuntu-latest
    name: "Job 5: Deploy to EC2"
    needs: push
    steps:
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: IMAGE_URI
          script: |
            set -e
            IMAGE_URI="${{ needs.push.outputs.image-uri }}"
            
            echo "========== Pulling latest image from ECR =========="
            echo "Image URI: $IMAGE_URI"
            docker pull $IMAGE_URI
            
            echo "========== Stopping old container =========="
            docker stop myapp || true
            docker rm myapp || true
            
            echo "========== Starting new container =========="
            docker run -d \
              --name myapp \
              --restart=always \
              -p 80:80 \
              $IMAGE_URI
            
            echo "========== Container started =========="
            docker ps -a | grep myapp
            echo "✅ Deployment to EC2 complete"

  # Job 6: Validate deployment
  validate:
    runs-on: ubuntu-latest
    name: "Job 6: Validate Deployment"
    needs: deploy
    steps:
      - name: Wait for app to be ready
        run: sleep 5

      - name: Test application endpoint
        run: |
          echo "========== Testing application endpoint =========="
          RESPONSE=$(curl -s -w "\n%{http_code}" http://${{ secrets.EC2_HOST }})
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ Application validation PASSED"
            exit 0
          else
            echo "❌ Application validation FAILED (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Check container status
        if: success()
        run: |
          echo "========== Container Status =========="
          echo "SSH into ${{ secrets.EC2_HOST }} to check logs:"
          echo "  ssh -i your_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
          echo "  docker ps"
          echo "  docker logs myapp"
          echo "✅ All validations passed!"
